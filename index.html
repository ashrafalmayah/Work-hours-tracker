<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Track your work hours efficiently" />
    <meta name="theme-color" content="#0f172a" />
    <title>Work Hours Tracker</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icons/icon-192.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
    <script src="https://kit.fontawesome.com/6bef7c705c.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase (compat libs for simplicity in single-file) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- small helper: dayjs for time parsing/format -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);
    </script>
    <style>
        /* Custom styles for enhanced UI */
        .hr-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        .hr-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .btn-secondary.active {
            background: #4f46e5;
            color: white;
        }

        .entry-item {
            transition: all 0.2s ease;
            border-left: 4px solid #4f46e5;
        }
        
        .entry-item:hover {
            transform: translateX(4px);
            background-color: #f8fafc;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        @media screen and (max-width: 1024px) {
            #left-menu.active {
                transform: translateX(0);
            }
        }
        
        .time-input {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-size: 1rem;
            width: 100%;
        }
        
        .time-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-cloud {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-local {
            background: #f0f9ff;
            color: #0369a1;
        }
        
        .auth-form input {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            width: 100%;
            margin-bottom: 0.75rem;
        }
        
        .auth-form input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .toast {
            background: #1e293b;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .segment-duration {
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            color: #475569;
        }
        
        .day-total {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        
        .nav-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .action-btn {
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #f1f5f9;
        }
        
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .icon-btn:hover {
            background: #f1f5f9;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row gap-4 items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <button id="btn-menu" class="icon-btn block lg:hidden">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="bg-indigo-600 text-white p-2 rounded-lg">
                    <i class="fas fa-clock text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Work Hours Tracker</h1>
                    <p class="text-sm text-slate-500">Track and manage your work hours efficiently</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div id="badge-mode" class="badge badge-local">
                    <i class="fas fa-laptop mr-1"></i>
                    <span>Local Mode</span>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left column controls -->
            <section id="left-menu" class="lg:col-span-1 absolute lg:relative max-lg:max-w-[min(400px,90vw)] max-lg:shadow-lg max-lg:w-screen top-0 left-0 bg-white max-lg:max-h-screen max-lg:overflow-y-auto lg:bg-transparent lg:relative -translate-x-full lg:translate-x-0 lg:relative space-y-6 transition-all duration-300">
                <div class="hr-card p-5">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2">
                        <i class="fas fa-user text-indigo-600"></i>
                        Profile
                    </h2>
                    <div id="auth-area" class="mt-2"></div>
                </div>

                <div class="hr-card p-5">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2">
                        <i class="fas fa-cloud text-indigo-600"></i>
                        Data Mode
                    </h2>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <button id="btn-cloud" class="flex-1 btn-secondary py-2 rounded-md flex items-center justify-center gap-2">
                                <i class="fas fa-cloud"></i>
                                Cloud
                            </button>
                            <button id="btn-local" class="flex-1 btn-secondary py-2 rounded-md flex items-center justify-center gap-2">
                                <i class="fas fa-laptop"></i>
                                Local
                            </button>
                        </div>
                        <p class="text-xs text-slate-500">
                            Cloud requires Firebase config. Local uses localStorage only.
                        </p>
                    </div>
                </div>

                <div class="hr-card p-5">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2">
                        <i class="fas fa-tools text-indigo-600"></i>
                        Actions
                    </h2>
                    <div class="space-y-2">
                        <button id="btn-export" class="w-full btn-secondary py-2 rounded-md flex items-center justify-center gap-2">
                            <i class="fas fa-file-export"></i>
                            Export CSV
                        </button>
                        <label class="w-full btn-secondary py-2 rounded-md flex items-center justify-center gap-2 cursor-pointer">
                            <i class="fas fa-file-import"></i>
                            Import CSV
                            <input id="csv-import" type="file" accept="text/csv" class="hidden" />
                        </label>
                        <button id="btn-clear-local" class="w-full btn-secondary py-2 rounded-md flex items-center justify-center gap-2 text-red-600">
                            <i class="fas fa-trash"></i>
                            Clear Local Data
                        </button>
                    </div>
                </div>

                <div class="hr-card p-5">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-indigo-600"></i>
                        Range Report
                    </h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs mb-1">From</label>
                                <input id="range-from" type="date" class="time-input" />
                            </div>
                            <div>
                                <label class="block text-xs mb-1">To</label>
                                <input id="range-to" type="date" class="time-input" />
                            </div>
                        </div>
                        <button id="btn-range-sum" class="w-full btn-primary py-2 rounded-md flex items-center justify-center gap-2">
                            <i class="fas fa-calculator"></i>
                            Calculate Total
                        </button>
                        <div id="range-sum" class="text-center font-semibold text-lg mt-2"></div>
                    </div>
                </div>

                <div class="hr-card p-5">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2">
                        <i class="fas fa-cog text-indigo-600"></i>
                        Settings
                    </h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="flex items-center gap-2">
                                <i class="fas fa-history text-slate-500"></i>
                                Enable Rounding
                            </label>
                            <input id="opt-rounding" type="checkbox" class="rounded text-indigo-600" />
                        </div>
                        <div>
                            <label class="block text-xs mb-1">Round to</label>
                            <select id="round-minutes" class="time-input">
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15" selected>15 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Middle: Day view -->
            <section class="lg:col-span-3">
                <div class="hr-card p-5">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-2">
                            <button id="prev-day" class="nav-btn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <input id="current-date" type="date" class="time-input text-center font-medium" />
                            <button id="next-day" class="nav-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div id="day-sum" class="day-total text-center md:text-right">Day total: 0h 00m</div>
                    </div>

                    <div class="text-sm text-slate-600 mb-4 flex items-center gap-2">
                        <i class="fas fa-globe-americas"></i>
                        <span id="local-tz">Timezone: Loading...</span>
                    </div>

                    <div id="segments-list" class="space-y-3 mb-6">
                        <!-- Entries will be inserted here -->
                        <div class="text-center py-8 text-slate-400">
                            <i class="fas fa-clock text-4xl mb-2"></i>
                            <p>No time entries for this day</p>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div class="md:col-span-2">
                            <label class="block text-xs mb-1">Start Time</label>
                            <input id="input-start" type="time" class="time-input" />
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs mb-1">End Time</label>
                            <input id="input-end" type="time" class="time-input" />
                        </div>
                        <div class="flex gap-2 items-end">
                            <button id="btn-now" class="flex-1 btn-secondary py-2 rounded-md flex items-center justify-center">
                                <i class="fas fa-clock"></i>
                            </button>
                            <button id="btn-add" class="flex-1 btn-primary py-2 rounded-md flex items-center justify-center">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mt-3 text-xs text-slate-500 flex items-center gap-1">
                        <i class="fas fa-lightbulb"></i>
                        <span>Tip: leave end empty to create an open segment you can close later.</span>
                    </div>
                </div>
            </section>
        </main>

        <footer class="mt-6 text-xs text-slate-500 text-center">
            <i class="fas fa-info-circle mr-1"></i>
            Times stored in UTC; displayed in your local timezone. Export CSV for backups.
        </footer>
    </div>

    <!-- Modal for editing entries -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-lg flex items-center gap-2">
                    <i class="fas fa-edit text-indigo-600"></i>
                    Edit Time Entry
                </h3>
                <button id="close-modal" class="icon-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input id="edit-date" type="date" class="time-input" />
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Start Time</label>
                        <input id="edit-start" type="time" class="time-input" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">End Time</label>
                        <input id="edit-end" type="time" class="time-input" />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Note (Optional)</label>
                    <textarea id="edit-note" class="time-input" rows="2" placeholder="Add a note about this time entry"></textarea>
                </div>
                
                <div class="flex justify-end gap-2 mt-6">
                    <button id="cancel-edit" class="btn-secondary px-4 py-2 rounded-md">
                        Cancel
                    </button>
                    <button id="save-edit" class="btn-primary px-4 py-2 rounded-md">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast" class="fixed right-4 bottom-4 z-50"></div>

    <script>
        // =====================
        // CONFIG PLACEHOLDERS
        // =====================

        // FIREBASE CONFIG: paste your config below. If left null the app will default to Local mode.
        /* FIREBASE CONFIG START */
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAmoZvYaoJa7JlORi9LbmCWoIe4QlsdgYc",
            authDomain: "work-hours-tracker-3d494.firebaseapp.com",
            projectId: "work-hours-tracker-3d494",
            storageBucket: "work-hours-tracker-3d494.firebasestorage.app",
            messagingSenderId: "416076479037",
            appId: "1:416076479037:web:1a5eec5328bae605004854",
            measurementId: "G-C9X5VQHPGT",
        };
        /* FIREBASE CONFIG END */

        // localStorage keys
        const STORAGE_KEY = "workhours_local_entries_v1";
        const STORAGE_SETTINGS = "workhours_local_settings_v1";

        // =====================
        // Utility helpers
        // =====================
        function uid() {
            return "id_" + Math.random().toString(36).slice(2, 9);
        }
        function nowISOUTC() {
            return new Date().toISOString();
        }

        function showToast(msg, timeout = 3500) {
            const toastContainer = document.getElementById('toast');
            const t = document.createElement("div");
            t.className = "toast";
            t.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-check-circle text-green-400"></i>
                    <span>${msg}</span>
                </div>
            `;
            toastContainer.appendChild(t);
            
            // Trigger animation
            setTimeout(() => t.classList.add('show'), 10);
            
            setTimeout(() => {
                t.classList.remove('show');
                setTimeout(() => t.remove(), 300);
            }, timeout);
        }

        function parseTimeInputToISO(localDate, timeStr, endsNextDay = false) {
            if (!timeStr) return null;
            
            // timeStr like 08:30 or 3:00 -> ensure two-digit
            const [hh, mm] = timeStr.split(":");
            const H = hh.padStart(2, "0");
            const M = (mm || "00").padStart(2, "0");
            // create local datetime then convert to UTC ISO
            const local = new Date(localDate + "T" + H + ":" + M + ":00");
            if (endsNextDay) local.setDate(local.getDate() + 1);
            console.log("start");
            
            console.log(new Date(local.getTime()).toISOString(), local.toString());
            
            console.log("end");
            return local.toISOString();
        }

        function isoToLocalTimeStr(iso, is12HourFormat = false) {
            if (!iso) return "";
            const d = new Date(iso);
            const hh = is12HourFormat ? String(d.getHours() % 12 || 12).padStart(2, "0") : String(d.getHours()).padStart(2, "0");
            const mm = String(d.getMinutes()).padStart(2, "0");
            const ampm = d.getHours() < 12 ? "AM" : "PM";
            return hh + ":" + mm + (is12HourFormat ? " " + ampm : "");
        }

        function durationFromISOs(startISO, endISO) {
            if (!startISO || !endISO) return null;
            const s = new Date(startISO).getTime();
            const e = new Date(endISO).getTime();
            let diff = Math.round((e - s) / 60000); // minutes
            return diff; // minutes
        }

        function formatMinutes(mins) {
            const h = Math.floor(mins / 60);
            const m = Math.abs(mins % 60);
            return `${h}h ${String(m).padStart(2, "0")}m`;
        }

        function roundTo(minutes, roundTo) {
            if (!roundTo) return minutes;
            return Math.round(minutes / roundTo) * roundTo;
        }

        // =====================
        // App State
        // =====================
        let MODE = FIREBASE_CONFIG ? "cloud" : "local"; // 'local' or 'cloud'
        let currentUser = null; // {uid, email}
        let db = null;
        let auth = null;
        let unsubscribeEntries = null;

        // In-memory cache of entries keyed by id
        let ENTRIES = {}; // { id: entry }
        let SETTINGS = {
            roundingEnabled: true,
            roundMinutes: 15,
        };

        // Current entry being edited
        let currentEditEntry = null;

        // =====================
        // Persistence: localStorage
        // =====================
        function loadLocal() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                const parsed = raw ? JSON.parse(raw) : [];
                ENTRIES = {};
                parsed.forEach((e) => (ENTRIES[e.id] = e));
                const sraw = localStorage.getItem(STORAGE_SETTINGS);
                if (sraw) SETTINGS = JSON.parse(sraw);
            } catch (err) {
                console.error(err);
            }
        }
        function saveLocal() {
            const list = Object.values(ENTRIES);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            localStorage.setItem(
                STORAGE_SETTINGS,
                JSON.stringify(SETTINGS)
            );
        }

        // =====================
        // Firestore helpers
        // =====================
        function initFirebase() {
            if (!FIREBASE_CONFIG) return null;
            try {
                firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                return {
                    auth,
                    db,
                };
            } catch (err) {
                console.error("Firebase init failed", err);
                return null;
            }
        }

        async function subscribeCloudEntries(uid) {
            if (!db) return;
            if (unsubscribeEntries) unsubscribeEntries();
            const col = db
                .collection("users")
                .doc(uid)
                .collection("entries");
            unsubscribeEntries = col.onSnapshot((snap) => {
                snap.docChanges().forEach((ch) => {
                    const data = ch.doc.data();
                    data.id = ch.doc.id;
                    if (ch.type === "removed") {
                        delete ENTRIES[data.id];
                    } else ENTRIES[data.id] = data;
                });
                renderDay();
            });
        }

        async function uploadEntryToCloud(uid, entry) {
            const col = db
                .collection("users")
                .doc(uid)
                .collection("entries");
            const id = entry.id || uid + "_" + uid();
            entry.modifiedAt = firebase.firestore.FieldValue.serverTimestamp
                ? firebase.firestore.FieldValue.serverTimestamp()
                : new Date().toISOString();
            try {
                await col.doc(id).set(entry, {
                    merge: true,
                });
            } catch (err) {
                console.error("upload failed", err);
            }
        }

        async function deleteEntryFromCloud(uid, id) {
            try {
                await db
                    .collection("users")
                    .doc(uid)
                    .collection("entries")
                    .doc(id)
                    .delete();
            } catch (e) {
                console.error(e);
            }
        }

        // =====================
        // UI rendering & interactions
        // =====================
        const el = {
            badgeMode: document.getElementById("badge-mode"),
            btnMenu: document.getElementById("btn-menu"),
            leftMenu: document.getElementById("left-menu"),
            authArea: document.getElementById("auth-area"),
            btnCloud: document.getElementById("btn-cloud"),
            btnLocal: document.getElementById("btn-local"),
            btnExport: document.getElementById("btn-export"),
            csvImport: document.getElementById("csv-import"),
            btnClearLocal: document.getElementById("btn-clear-local"),
            currentDate: document.getElementById("current-date"),
            prevDay: document.getElementById("prev-day"),
            nextDay: document.getElementById("next-day"),
            segmentsList: document.getElementById("segments-list"),
            daySum: document.getElementById("day-sum"),
            inputStart: document.getElementById("input-start"),
            inputEnd: document.getElementById("input-end"),
            btnAdd: document.getElementById("btn-add"),
            btnNow: document.getElementById("btn-now"),
            btnRangeSum: document.getElementById("btn-range-sum"),
            rangeFrom: document.getElementById("range-from"),
            rangeTo: document.getElementById("range-to"),
            rangeSum: document.getElementById("range-sum"),
            optRounding: document.getElementById("opt-rounding"),
            roundMinutes: document.getElementById("round-minutes"),
            localTz: document.getElementById("local-tz"),
            editModal: document.getElementById("edit-modal"),
            closeModal: document.getElementById("close-modal"),
            cancelEdit: document.getElementById("cancel-edit"),
            saveEdit: document.getElementById("save-edit"),
            editDate: document.getElementById("edit-date"),
            editStart: document.getElementById("edit-start"),
            editEnd: document.getElementById("edit-end"),
            editNote: document.getElementById("edit-note"),
        };

        function updateModeBadge() {
            if (MODE === "cloud") {
                el.badgeMode.innerHTML = currentUser 
                    ? `<i class="fas fa-cloud mr-1"></i><span>Cloud: ${currentUser.email || currentUser.uid}</span>`
                    : `<i class="fas fa-cloud mr-1"></i><span>Cloud (Not Signed In)</span>`;
                el.badgeMode.className = "badge badge-cloud";
                el.btnCloud.classList.add('active');
                el.btnLocal.classList.remove('active');
            } else {
                el.badgeMode.innerHTML = `<i class="fas fa-laptop mr-1"></i><span>Local Mode</span>`;
                el.badgeMode.className = "badge badge-local";
                el.btnLocal.classList.add('active');
                el.btnCloud.classList.remove('active');
            }
        }

        function renderAuthArea() {
            el.authArea.innerHTML = "";
            if (MODE === "cloud") {
                if (!auth) {
                    el.authArea.innerHTML = `
                        <div class="text-sm text-red-600 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Firebase not configured.
                        </div>
                    `;
                    return;
                }
                if (!currentUser) {
                    const authForm = document.createElement("div");
                    authForm.className = "auth-form";
                    authForm.innerHTML = `
                        <input type="email" placeholder="Email" id="auth-email" />
                        <input type="password" placeholder="Password" id="auth-password" />
                        <button id="btn-signin" class="w-full btn-primary py-2 rounded-md flex items-center justify-center gap-2">
                            <i class="fas fa-sign-in-alt"></i>
                            Sign in / Register
                        </button>
                        <button id="btn-google" class="w-full btn-secondary py-2 rounded-md flex items-center justify-center gap-2 mt-2">
                            <i class="fab fa-google"></i>
                            Sign in with Google
                        </button>
                    `;
                    el.authArea.appendChild(authForm);
                    
                    document.getElementById("btn-signin").onclick = async () => {
                        const email = document.getElementById("auth-email").value;
                        const password = document.getElementById("auth-password").value;
                        try {
                            const res = await auth
                                .signInWithEmailAndPassword(email, password)
                                .catch(async (err) => {
                                    if (err.code === "auth/user-not-found") {
                                        await auth.createUserWithEmailAndPassword(email, password);
                                        showToast("Account created successfully.");
                                    } else {
                                        throw err;
                                    }
                                });
                        } catch (e) {
                            showToast((e.message || e.code) + "");
                            console.error(e);
                        }
                    };
                    
                    document.getElementById("btn-google").onclick = async () => {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        try {
                            await auth.signInWithPopup(provider);
                        } catch (e) {
                            showToast(e.message || e.code);
                        }
                    };
                } else {
                    const userInfo = document.createElement("div");
                    userInfo.className = "space-y-3";
                    userInfo.innerHTML = `
                        <div class="flex items-center gap-2 p-2 bg-slate-100 rounded-md">
                            <i class="fas fa-user text-slate-600"></i>
                            <span class="font-medium">${currentUser.email || currentUser.uid}</span>
                        </div>
                        <button id="btn-signout" class="w-full btn-secondary py-2 rounded-md flex items-center justify-center gap-2">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign out
                        </button>
                    `;
                    el.authArea.appendChild(userInfo);
                    document.getElementById("btn-signout").onclick = () => auth.signOut();
                }
            } else {
                el.authArea.innerHTML = `
                    <div class="text-sm text-slate-600 flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        Local mode. Data stored with localStorage.
                    </div>
                `;
            }
        }

        function renderDay() {
            const dateStr = el.currentDate.value;
            if (!dateStr) return;
            // filter entries for the date
            const list = Object.values(ENTRIES)
                .filter((e) => e.date === dateStr)
                .sort((a, b) =>
                    (a.startISO || "") > (b.startISO || "") ? 1 : -1
                );
                
            el.segmentsList.innerHTML = "";
            
            if (list.length === 0) {
                el.segmentsList.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <i class="fas fa-clock text-4xl mb-2"></i>
                        <p>No time entries for this day</p>
                    </div>
                `;
                el.daySum.textContent = "Day total: 0h 00m";
                return;
            }
            
            let total = 0;
            list.forEach((entry) => {
                const row = document.createElement("div");
                row.className = "entry-item p-3 bg-white border rounded-lg flex items-center justify-between";
                
                const left = document.createElement("div");
                left.className = "flex flex-col";
                
                const times = document.createElement("div");
                times.className = "text-sm font-medium flex items-center gap-2";
                
                const startStr = isoToLocalTimeStr(entry.startISO, true);
                const endStr = entry.endISO ? isoToLocalTimeStr(entry.endISO, true) : "<span class='text-orange-500'>Open</span>";
                times.innerHTML = `
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${startStr}</span>
                    <i class="fas fa-arrow-right text-slate-400"></i>
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${endStr}</span>
                `;
                
                const note = document.createElement("div");
                note.className = "text-xs text-slate-500 mt-1 flex items-center gap-1";
                if (entry.note) {
                    note.innerHTML = `<i class="fas fa-sticky-note"></i> ${entry.note}`;
                } else {
                    note.innerHTML = `<i class="fas fa-sticky-note text-slate-300"></i> No note`;
                }
                
                left.appendChild(times);
                left.appendChild(note);

                const right = document.createElement("div");
                right.className = "flex flex-col md:flex-row items-center gap-2";
                
                const durMins = entry.startISO && entry.endISO
                    ? durationFromISOs(entry.startISO, entry.endISO)
                    : null;
                    
                if (durMins !== null) {
                    const rmins = SETTINGS.roundingEnabled
                        ? roundTo(durMins, SETTINGS.roundMinutes)
                        : durMins;
                    total += rmins;
                    const dspan = document.createElement("div");
                    dspan.className = "segment-duration";
                    dspan.textContent = formatMinutes(rmins);
                    right.appendChild(dspan);
                } else {
                    const openSpan = document.createElement("div");
                    openSpan.className = "segment-duration bg-orange-100 text-orange-800";
                    openSpan.innerHTML = `<i class="fas fa-clock"></i> Open`;
                    right.appendChild(openSpan);
                }
                
                const editBtn = document.createElement("button");
                editBtn.className = "action-btn text-blue-600";
                editBtn.innerHTML = `<i class="fas fa-edit"></i>`;
                editBtn.title = "Edit entry";
                editBtn.onclick = () => openEditModal(entry);
                
                const delBtn = document.createElement("button");
                delBtn.className = "action-btn text-red-600";
                delBtn.innerHTML = `<i class="fas fa-trash"></i>`;
                delBtn.title = "Delete entry";
                delBtn.onclick = () => deleteEntry(entry.id);
                
                const actionsContainer = document.createElement("div");
                actionsContainer.className = "flex items-center gap-2";
                actionsContainer.appendChild(editBtn);
                actionsContainer.appendChild(delBtn);
                right.appendChild(actionsContainer);

                row.appendChild(left);
                row.appendChild(right);
                el.segmentsList.appendChild(row);
            });
            
            el.daySum.textContent = "Day total: " + formatMinutes(total);
        }

        function openEditModal(entry) {
            currentEditEntry = entry;
            el.editDate.value = entry.date;
            el.editStart.value = isoToLocalTimeStr(entry.startISO, false);
            el.editEnd.value = entry.endISO ? isoToLocalTimeStr(entry.endISO, false) : "";
            el.editNote.value = entry.note || "";
            el.editModal.classList.add('active');
        }

        function closeEditModal() {
            el.editModal.classList.remove('active');
            currentEditEntry = null;
        }

        // =====================
        // CRUD
        // =====================
        function addEntry(entry) {
            entry.id = entry.id || uid();
            entry.createdAt = entry.createdAt || nowISOUTC();
            entry.modifiedAt = nowISOUTC();
            ENTRIES[entry.id] = entry;
            if (MODE === "cloud" && currentUser && db) {
                uploadEntryToCloud(currentUser.uid, entry);
            } else saveLocal();
            renderDay();
            showToast("Time entry added successfully");
        }

        function updateEntry(entry) {
            entry.modifiedAt = nowISOUTC();
            ENTRIES[entry.id] = entry;
            if (MODE === "cloud" && currentUser)
                uploadEntryToCloud(currentUser.uid, entry);
            else saveLocal();
            renderDay();
            showToast("Time entry updated successfully");
        }

        function deleteEntry(id) {
            if (!confirm("Are you sure you want to delete this time entry?")) return;
            if (MODE === "cloud" && currentUser && db) {
                deleteEntryFromCloud(currentUser.uid, id);
            } else {
                delete ENTRIES[id];
                saveLocal();
                renderDay();
            }
            showToast("Time entry deleted");
        }

        // =====================
        // UI events wiring
        // =====================
        function wireEvents() {
            document.body.onclick = (e) => {
                const shouldClose = !e.target.closest('#left-menu') && !e.target.closest('#btn-menu');
                if (shouldClose) {
                    el.leftMenu.classList.remove('active');
                }
            };
            el.btnMenu.onclick = () => {
                el.leftMenu.classList.toggle('active');
            };
            el.btnCloud.onclick = () => {
                if (FIREBASE_CONFIG) {
                    MODE = "cloud";
                    initFirebase();
                    renderAuthArea();
                    updateModeBadge();
                    showToast("Switched to Cloud mode");
                } else {
                    showToast("No Firebase config. Paste config at top.");
                }
            };
            el.btnLocal.onclick = () => {
                MODE = "local";
                renderAuthArea();
                updateModeBadge();
                loadLocal();
                renderDay();
                showToast("Switched to Local mode");
            };
            el.btnExport.onclick = () => exportCSV();
            el.csvImport.onchange = (ev) => importCSV(ev.target.files[0]);
            el.btnClearLocal.onclick = () => {
                if (confirm("This will permanently delete all local time entries. Continue?")) {
                    ENTRIES = {};
                    saveLocal();
                    renderDay();
                    showToast("Local data cleared");
                }
            };
            el.prevDay.onclick = () => {
                changeDayBy(-1);
            };
            el.nextDay.onclick = () => {
                changeDayBy(1);
            };
            el.currentDate.onchange = () => renderDay();
            el.btnAdd.onclick = () => {
                const date = el.currentDate.value;
                if (!date) {
                    showToast("Please select a date first.");
                    return;
                }
                const startT = el.inputStart.value;
                const endT = el.inputEnd.value;
                const entry = {
                    date,
                    startISO: startT
                        ? parseTimeInputToISO(date, startT)
                        : null,
                    endISO: endT ? parseTimeInputToISO(date, endT) : null,
                    note: "",
                    createdAt: nowISOUTC(),
                    modifiedAt: nowISOUTC(),
                };
                addEntry(entry);
                el.inputStart.value = "";
                el.inputEnd.value = "";
            };
            el.btnNow.onclick = () => {
                const t = new Date();
                const hh = String(t.getHours()).padStart(2, "0");
                const mm = String(t.getMinutes()).padStart(2, "0");
                el.inputStart.value = hh + ":" + mm;
            };
            el.btnRangeSum.onclick = () => {
                showRangeSum();
            };
            el.optRounding.onchange = () => {
                SETTINGS.roundingEnabled = el.optRounding.checked;
                saveLocal();
                renderDay();
            };
            el.roundMinutes.onchange = () => {
                SETTINGS.roundMinutes = parseInt(el.roundMinutes.value);
                saveLocal();
                renderDay();
            };
            
            // Modal events
            el.closeModal.onclick = closeEditModal;
            el.cancelEdit.onclick = closeEditModal;
            el.saveEdit.onclick = () => {
                if (!currentEditEntry) return;
                
                const newDate = el.editDate.value;
                const newStart = el.editStart.value;
                const newEnd = el.editEnd.value;
                const newNote = el.editNote.value;
                
                if (!newDate) {
                    showToast("Please select a date.");
                    return;
                }
                
                if (!newStart) {
                    showToast("Please enter a start time.");
                    return;
                }
                
                currentEditEntry.date = newDate;
                currentEditEntry.startISO = parseTimeInputToISO(newDate, newStart);
                currentEditEntry.endISO = newEnd ? parseTimeInputToISO(newDate, newEnd) : null;
                currentEditEntry.note = newNote;
                
                updateEntry(currentEditEntry);
                closeEditModal();
            };
            
            // Close modal when clicking outside
            el.editModal.onclick = (e) => {
                if (e.target === el.editModal) {
                    closeEditModal();
                }
            };
        }

        function changeDayBy(delta) {
            const cur = el.currentDate.value
                ? new Date(el.currentDate.value)
                : new Date();
            cur.setDate(cur.getDate() + delta);
            el.currentDate.value = cur.toISOString().slice(0, 10);
            renderDay();
        }

        // =====================
        // Reports & CSV
        // =====================
        function showRangeSum() {
            const from = el.rangeFrom.value;
            const to = el.rangeTo.value;
            if (!from || !to) {
                showToast("Please select both start and end dates.");
                return;
            }
            const start = new Date(from);
            const end = new Date(to);
            end.setHours(23, 59, 59, 999);
            const items = Object.values(ENTRIES).filter((e) => {
                const d = new Date(e.date + "T00:00:00");
                return d >= start && d <= end;
            });
            let total = 0;
            items.forEach((it) => {
                if (it.startISO && it.endISO) {
                    let m = durationFromISOs(it.startISO, it.endISO);
                    if (SETTINGS.roundingEnabled)
                        m = roundTo(m, SETTINGS.roundMinutes);
                    total += m;
                }
            });
            el.rangeSum.innerHTML = `
                <div class="text-indigo-600">Total: ${formatMinutes(total)}</div>
                <div class="text-xs text-slate-500 mt-1">From ${from} to ${to}</div>
            `;
        }

        function exportCSV() {
            const rows = [
                "id,date,startISO,endISO,duration_minutes,duration_hhmm,note",
            ];
            Object.values(ENTRIES).forEach((e) => {
                const dur =
                    e.startISO && e.endISO
                        ? durationFromISOs(e.startISO, e.endISO)
                        : "";
                const durStr = dur ? formatMinutes(dur) : "";
                rows.push(
                    [
                        e.id,
                        e.date,
                        e.startISO || "",
                        e.endISO || "",
                        dur || "",
                        durStr,
                        '"' + (e.note || "") + '"',
                    ].join(",")
                );
            });
            const blob = new Blob([rows.join("\n")], {
                type: "text/csv",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "workhours_export.csv";
            a.click();
            URL.revokeObjectURL(url);
            showToast("CSV exported successfully");
        }

        function importCSV(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(Boolean);
                const header = lines.shift();
                lines.forEach((line) => {
                    const cols = line.split(/,(?=(?:[^"]"[^"]")[^"]$)/); // naive CSV split
                    const id = cols[0] || uid();
                    const date = cols[1] || "";
                    const startISO = cols[2] || null;
                    const endISO = cols[3] || null;
                    const note = (cols[6] || "").replace(/^"|"$/g, "");
                    const entry = {
                        id,
                        date,
                        startISO,
                        endISO,
                        note,
                        createdAt: nowISOUTC(),
                        modifiedAt: nowISOUTC(),
                    };
                    ENTRIES[id] = entry;
                    if (MODE === "cloud" && currentUser && db)
                        uploadEntryToCloud(currentUser.uid, entry);
                });
                saveLocal();
                renderDay();
                showToast("CSV imported successfully");
            };
            reader.readAsText(file);
        }

        // =====================
        // Sync & merge local-to-cloud on first sign-in
        // =====================
        async function mergeLocalToCloud(uid) {
            if (!db) return;
            const localList = Object.values(ENTRIES);
            if (!localList.length) return;
            if (
                !confirm(
                    "Local data detected. Merge into cloud? (Cancel to keep separate)"
                )
            )
                return;
            for (const e of localList) {
                const id = e.id || uid + "_" + uid();
                await db
                    .collection("users")
                    .doc(uid)
                    .collection("entries")
                    .doc(id)
                    .set(e);
            }
            ENTRIES = {};
            saveLocal();
            renderDay();
            showToast("Local data merged to cloud");
        }

        // =====================
        // Init App
        // =====================
        function initUI() {
            loadLocal();
            wireEvents();
            el.localTz.textContent =
                "Timezone: " +
                Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (!el.currentDate.value)
                el.currentDate.value = new Date()
                    .toISOString()
                    .slice(0, 10);
            el.rangeFrom.value = new Date().toISOString().slice(0, 10);
            el.rangeTo.value = new Date().toISOString().slice(0, 10);
            el.optRounding.checked = SETTINGS.roundingEnabled;
            el.roundMinutes.value = SETTINGS.roundMinutes;
            updateModeBadge();
            renderAuthArea();
            renderDay();
        }

        // Firebase auth state handling
        function setupFirebaseAuthHandlers() {
            if (!auth) return;
            auth.onAuthStateChanged(async (u) => {
                if (u) {
                    currentUser = {
                        uid: u.uid,
                        email: u.email,
                    };
                    // merge if local data exists
                    if (Object.keys(ENTRIES).length)
                        await mergeLocalToCloud(u.uid);
                    // load cloud entries into ENTRIES
                    ENTRIES = {};
                    subscribeCloudEntries(u.uid);
                    showToast(`Signed in as ${u.email}`);
                } else {
                    currentUser = null;
                    if (unsubscribeEntries) {
                        unsubscribeEntries();
                        unsubscribeEntries = null;
                    }
                    // fallback to local
                    loadLocal();
                    renderDay();
                }
                renderAuthArea();
                updateModeBadge();
            });
        }

        // When uploading, we set timestamps but for local we use nowISOUTC
        initUI();
        if (FIREBASE_CONFIG) {
            const fb = initFirebase();
            if (fb) {
                auth = fb.auth;
                db = fb.db;
                setupFirebaseAuthHandlers();
            }
        }
    </script>
</body>
</html>